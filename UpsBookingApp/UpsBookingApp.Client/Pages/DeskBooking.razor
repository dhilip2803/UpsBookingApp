@page "/desk-booking"
@rendermode InteractiveWebAssembly
@inject HttpClient Http
@using System.Net.Http.Json
@using UpsBookingApp.Client.Models

<h3>Desk Booking</h3>


@if (!string.IsNullOrWhiteSpace(confirmationMessage))
{
    <p style="color: green;"><b>@confirmationMessage</b></p>
}

@if (desks.Any())
{
    <div class="row mb-3">
        <div class="col-md-4">
            <label>Select Floor:</label>
            <select class="form-select" @bind="selectedFloor">
                <option value="">-- Select Floor --</option>
                @foreach (var floor in desks.Select(d => d.Floor).Distinct())
                {
                    <option value="@floor">@floor</option>
                }
            </select>
        </div>
        <div class="col-md-4">
            <label>Filter:</label>
            <select class="form-select" @bind="selectedFilter">
                <option value="All">Show All</option>
                <option value="Available">Show Available</option>
            </select>
        </div>
        <div class="col-md-4 d-flex align-items-end">
            <button class="btn btn-primary w-100" @onclick="SearchDesks">Search</button>
        </div>
    </div>

    <div class="mb-3 row">
        <div class="col-md-6">
            <label>Start Time:</label>
            <input class="form-control" type="datetime-local" @bind="startTime" />
        </div>
        <div class="col-md-6">
            <label>End Time:</label>
            <input class="form-control" type="datetime-local" @bind="endTime" />
        </div>
    </div>

    @if (!string.IsNullOrWhiteSpace(selectedFloor))
    {
        <button class="btn btn-outline-info mb-3" @onclick="SuggestDesk">Suggest Desk</button>

        <div class="row">
            @foreach (var desk in filteredDesks)
            {
                <div class="col-md-4 mb-3">
                    <div class="card p-3">
                        <h5>@desk.Name</h5>
                        <p>Location: @desk.Location</p>
                        <p>Status: <b>@(desk.IsAvailable ? "Available" : "Booked")</b></p>

                        @if (desk.IsAvailable)
                        {
                            <button class="btn btn-primary" @onclick="() => BookDesk(desk)">Book</button>
                        }
                        else
                        {
                            <button class="btn btn-secondary" disabled>Unavailable</button>
                        }
                    </div>
                </div>
            }
        </div>
    }

    @if (!string.IsNullOrWhiteSpace(suggestedDeskMessage))
    {
        <p class="text-success">@suggestedDeskMessage</p>
    }

}
else
{
    <p>Loading desks...</p>
}

@code {
    private List<Desk> desks = new();
    private List<Desk> filteredDesks = new();
    private List<Booking> allBookings = new();
    private List<Booking> myBookings = new();

    private string selectedFloor = "";
    private string selectedFilter = "Available";
    private string userName = "Dhilip"; // Replace with logged-in user in future
    private DateTime startTime = DateTime.Now;
    private DateTime endTime = DateTime.Now.AddHours(1);

    private string? confirmationMessage;
    private string? suggestedDeskMessage;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        desks = await Http.GetFromJsonAsync<List<Desk>>("api/BookingApi/desks") ?? new();
        allBookings = await Http.GetFromJsonAsync<List<Booking>>("api/BookingApi/bookings") ?? new();

        myBookings = allBookings
            .Where(b => b.UserName.Equals(userName, StringComparison.OrdinalIgnoreCase))
            .ToList();
    }

    private void FilterDesks()
    {
        var bookingsInSlot = allBookings
            .Where(b =>
                b.StartTime < endTime &&
                b.EndTime > startTime)
            .Select(b => b.DeskId)
            .ToHashSet();

        filteredDesks = desks
            .Where(d => d.Floor == selectedFloor)
            .Where(d => selectedFilter == "All" || !bookingsInSlot.Contains(d.Id))
            .Select(d => new Desk
            {
                Id = d.Id,
                Name = d.Name,
                Location = d.Location,
                Floor = d.Floor,
                IsAvailable = !bookingsInSlot.Contains(d.Id)
            }).ToList();
    }

    private void SuggestDesk()
    {
        var suggestion = filteredDesks.FirstOrDefault(d => d.IsAvailable);
        suggestedDeskMessage = suggestion is not null
            ? $"Suggested Desk: {suggestion.Name} at {suggestion.Location}"
            : "No desks available for the selected time.";
    }

    private async Task BookDesk(Desk desk)
    {
        var booking = new Booking
        {
            DeskId = desk.Id,
            UserName = userName,
            StartTime = startTime,
            EndTime = endTime
        };

        var response = await Http.PostAsJsonAsync("api/BookingApi/book", booking);
        confirmationMessage = response.IsSuccessStatusCode ? "✅ Booking successful!" : "❌ Booking failed.";

        await LoadData();
        FilterDesks();
    }

    private async Task CancelDesk(int deskId)
    {
        var response = await Http.PostAsync($"api/BookingApi/cancel/{deskId}", null);
        confirmationMessage = response.IsSuccessStatusCode ? "Booking cancelled." : "❌ Failed to cancel.";

        await LoadData();
        FilterDesks();
    }

    private async Task SearchDesks()
    {
        await LoadData();
        FilterDesks();
    }

    private Task OnTypeChanged(ChangeEventArgs e)
    {
        // Reserved for booking type filter
        return Task.CompletedTask;
    }
}
